<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>마스크 검색</title>
	<style>
		* {line-height:1.5em; margin:0; padding:0; box-sizing:border-box; font-family:'Helvetica Neue', 'Apple SD Gothic Neo', 'Droid Sans', 'Malgun Gothic', '맑은 고딕', Dotum, 돋움, sans-serif; font-size:100%; color:#333; list-style:none; word-break:keep-all;}
		body {padding:15px;}
		h1 {margin-bottom:15px; font-size:24px; text-align:center;}
		input[type='range'] {display:block; width:80%; margin:15px auto;}
		.guide {margin:15px 0; font-size:12px; text-align:center;}
		.guide span {color:firebrick; font-weight:700;}
		#map {width:100%; height:calc(100vh - 150px);}
		.info {margin-top:-55px; padding:0 3px; border:1px solid #000; border-radius:3px; background:#fff;}
		.info a {display:block; line-height:1.5em; font-size:14px; text-decoration:none;}
	</style>
</head>

<body>

	<h1>마스크 검색</h1>
	<input type="range" min="0" max="5000" value="1000" step="200" id="range">
	<p class="guide">현 위치 기준 반경 <span id="distance">1000m</span>의 판매처를 검색합니다.</p>
	<div id="map"></div>

	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f164c351143842dcf294f0d038f8e54c"></script>
	<script>

		var range = document.querySelector("#range");
		range.addEventListener("change", function () {
			document.querySelector("#distance").innerText = this.value + 'm';
			getLocation(this.value);
		});

		function getLocation(dist) {
			dist = dist || range.value;
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function (position) {
					getData(position.coords.latitude, position.coords.longitude, dist)
				}, function (error) {
					console.error(error);
				}, {
					enableHighAccuracy: false,
					maximumAge: 0,
					timeout: Infinity
				});
			} else {
				alert('GPS를 지원하지 않는 환경에서는 사용할 수 없습니다.');
			};
		};

		function getData(lat, lng, dist) {
			fetch(`https://8oi9s0nnth.apigw.ntruss.com/corona19-masks/v1/storesByGeo/json?lat=${lat}&lng=${lng}&m=${dist}`)
				.then(function (response) {
					return response.json();
				})
				.then(function (json) {
					const data = json.stores;
					mapDraw(lat, lng, dist, data);
				});
		};

		function mapDraw(lat, lng, dist, data) {
			var container = document.getElementById('map');

			var map = new kakao.maps.Map(container, {
				center: new kakao.maps.LatLng(lat, lng),
				level: 4
			});

			var few = 'img/ico_few.png';
			some = 'img/ico_some.png';
			plenty = 'img/ico_plenty.png';
			imageSrc = "",
				imageSize = new kakao.maps.Size(20, 28),
				imageOption = { offset: new kakao.maps.Point(10, 28) };

			for (var i = 0; i < data.length; i++) {
				if (data[i].remain_stat === "empty") continue;
				if (data[i].remain_stat === "break") continue;
				if (data[i].remain_stat === null) continue;
				if (data[i].remain_stat === undefined) continue;
				switch (data[i].remain_stat) {
					case "plenty": imageSrc = plenty; break;
					case "some": imageSrc = some; break;
					case "few": imageSrc = few; break;
				}

				var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
				var markerPosition = new kakao.maps.LatLng(data[i].lat, data[i].lng);
				var marker = new kakao.maps.Marker({
					position: markerPosition,
					image: markerImage
				});

				var content = `
					<div class="info">
						<a href="https://map.kakao.com/link/map/${data[i].name},${data[i].lat},${data[i].lng}" target="_blank">
							${data[i].name}
						</a>
					</div>
				`;

				var customOverlay = new kakao.maps.CustomOverlay({
					map: map,
					position: markerPosition,
					content: content,
					yAnchor: 1
				});

				marker.setMap(map);

			}

			var circle = new kakao.maps.Circle({
				map: map,
				center: new kakao.maps.LatLng(lat, lng),
				radius: dist,
				strokeWeight: 0,
				strokeColor: '#000',
				strokeOpacity: 0,
				strokeStyle: 'solid',
				fillColor: 'steelblue',
				fillOpacity: .25
			});
		}

		(function init() {
			getLocation();
		})();

	</script>
</body>

</html>