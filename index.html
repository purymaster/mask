<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>마스크 검색</title>
	<style>
		* {line-height:1.5em; margin:0; padding:0; box-sizing:border-box; font-family:'Helvetica Neue', 'Apple SD Gothic Neo', 'Droid Sans', 'Malgun Gothic', '맑은 고딕', Dotum, 돋움, sans-serif; font-size:100%; color:#333; list-style:none; word-break:keep-all;}
		body {padding:15px;}
		h1 {margin-bottom:15px; font-size:24px; text-align:center;}
		.guide {font-size:14px; margin-bottom:15px;}
		.guide li {position:relative; padding-left:15px;}
		.guide li:before {content:""; position:absolute; left:5px; top:8px; width:4px; height:4px; border-radius:50%; background:#333;}
		.guide li em {font-weight:700; font-style:normal; color:firebrick;}
		.popup {display:none; margin-bottom:15px; padding:15px; line-height:1.4em; background:darkgreen; font-size:18px; font-weight:700; color:#fff; text-align:center;}
		.popup.on {display:block;}
		caption {overflow:hidden; position:absolute; width:1px; height:1px; margin:-1px; padding:0; border:0; clip:rect(0 0 0 0);}
		form {margin-bottom:15px;}
		fieldset {border:0; font-size:0;}
		fieldset input {width:calc(100% - 50px); height:40px; line-height:40px; padding:0 15px; border:1px solid #333; border-radius:0; font-size:16px; -webkit-appearance:none; -moz-appearance:none; -ms-appearance:none; -o-appearance:none;}
		fieldset button {width:50px; line-height:38px; border:1px solid #333; border-left:0; background:#efefef; font-size:16px; cursor:pointer;}
		.today,
		.reload {line-height:1.5em; font-size:14px; text-align:right;}
		.today span,
		.reload span {color:firebrick; font-weight:700;}
		.table_wrap {position:relative; margin-top:15px;}
		.table_wrap:before {content:""; display:none; position:absolute; top:0; right:0; bottom:0; left:0; background:#fff;}
		.table_wrap.on:before {display:block;}
		.table_wrap .loading {display:none; position:absolute; top:0; left:50%; width:40px; height:40px; margin-left:-25px; border:5px solid #ccc; border-top:5px solid #333; border-radius:50%; text-indent:-9999px; -webkit-animation:spin 1s linear infinite; animation:spin 1s linear infinite;}
		.table_wrap.on .loading {display:block;}
		table {width:100%; table-layout:fixed; border-top:1px solid #333; border-right:1px solid #333; background:#fff; font-size:14px; border-spacing:0; border-collapse:collapse;}
		table th,
		table td {padding:.5em .3em; border-bottom:1px solid #333; border-left:1px solid #333;}
		table thead th {background:azure;}
		table tr td:nth-child(n+3) {text-align:center;}
		table tr td.plenty {background:darkgreen; color:#fff;}
		table tr td.some {background:gold;}
		table tr td.few {background:firebrick; color:#fff;}
		table tr td.empty {background:#ccc;}
		table tr td.break {background:#333; color:#fff;}

		@media (max-width:1024px) {
			.table_wrap {overflow:hidden;}
			.table_wrap:before {position:fixed;}
			.table_wrap .loading {position:fixed; top:50%; margin-top:-25px;}
			table,
			tbody,
			tr,
			th,
			td {display:block; float:left; clear:both; width:100%; border:0; text-align:left !important;}
			thead {display:none;}
			table tr {padding:15px 0; border-bottom:1px solid #333;}
			table tr:first-child {border-top:1px solid #333;}
			table th,
			table td {line-height:1.5em; padding:0; border:0;}
			table tr td:nth-child(1) {margin-bottom:15px; font-size:18px; font-weight:700;}
			table tr td:nth-child(3) {display:none;}
			table tr td:nth-child(4):before {content:'입고시간 : ';}
			table tr td:nth-child(5) {width:auto; margin-top:15px; padding:5px; border:1px solid #333;}
		}

		@-webkit-keyframes spin {
			to {-webkit-transform: rotate(360deg); transform: rotate(360deg);}
		}

		@keyframes spin {
			to {-webkit-transform: rotate(360deg); transform: rotate(360deg);}
		}
	</style>
	
</head>

<body>
	<p class="popup">수량이 충분한(100개 이상) 마스크 판매처가 확인되었습니다.</p>
	<h1>마스크 검색</h1>
	<ul class="guide">
		<li>공공데이터의 주소 값을 기반으로 만든 코딩 연습용 페이지입니다.</li>
		<li>주소 입력은 지번 주소만 가능하며, <em>표준명칭 및 띄어쓰기 기준으로 정확하게 입력</em>하셔야 합니다.<br>(서울특별시 강남구 청담동, 제주특별자치도 제주시)</li>
		<li>주소는 <em>읍면동 단위까지 유효</em>합니다. 검색 결과가 존재하지 않을 경우, 상위 행정구역으로 검색 시도 바랍니다.</li>
		<li><em>현재 세종특별자치시는 검색 기능을 사용할 수 없습니다.</em></li>
		<li>인터넷 익스플로러에서는 동작하지 않습니다.</li>
	</ul>
	<form>
		<fieldset>
			<input type="text" placeholder="주소입력">
			<button type="submit">검색</button>
		</fieldset>
	</form>
	<p class="today">출생년도 끝자리 <span class="year"></span> 구매가능</p>
	<p class="reload"><span class="timer"></span>초 후 새로고침</p>
	
	<div class="table_wrap">
		<div class="loading">
			<p>로딩중입니다.</p>
		</div>
		<table>
			<caption>마스크 판매 정보</caption>
			<colgroup>
				<col style="width:200px;">
				<col>
				<col style="width:150px;">
				<col style="width:150px;">
				<col style="width:80px;">
			</colgroup>
			<thead>
				<tr>
					<th scope="col">판매처</th>
					<th scope="col">주소</th>
					<th scope="col">데이터등록시간</th>
					<th scope="col">입고시간</th>
					<th scope="col">재고</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>

	<script>
		const dataTable = document.querySelector("tbody"),
			loading = document.querySelector(".table_wrap"),
			form = document.querySelector("form"),
			input = form.querySelector("input"),
			timer = document.querySelector(".timer"),
			today = document.querySelector(".year"),
			spot = "spot";
		let count = 60,
			alertFlag = false;
		timer.innerHTML = count;

		function setCache() {
			let currentData = input.value;
			localStorage.setItem(spot, currentData);
			getData(currentData);
		};

		function getLocation() {
			form.addEventListener("submit", setCache);
		};

		function setBuyYear(today) {
			switch (today) {
				case 1: 
					return "1, 6";
					break;
				case 2: 
					return "2, 7";
					break;
				case 3: 
					return "3, 8";
					break;
				case 4: 
					return "4, 9";
					break;
				case 5: 
					return "5, 0";
					break;
				default:
					return false;
					break;
			};
		};

		function getMaskStock(amount) {
			switch (amount) {
				case "plenty":
					return "100개이상";
					break;
				case "some":
					return "30~99개";
					break;
				case "few":
					return "2~29개";
					break;
				case "empty":
					return "재고없음";
					break;
				case "break":
					return "판매중지";
					break;
				default:
					return "데이터없음";
					break;
			};
		};

		function getData(location) {
			loading.classList.add('on');
			fetch(`https://8oi9s0nnth.apigw.ntruss.com/corona19-masks/v1/storesByAddr/json?address=${location}`)
				.then(function(response) {
					return response.json();
				})
				.then(function(json) {
					const data = json.stores;
					let dataMarkUp = "",
						dataTemplete;
					
					if(data.length) {
						for (let i = 0; i < data.length; i++) {
							if (data[i].remain_stat === "plenty") alertFlag = true;
							dataTemplete = `
								<tr>
									<td>
										<a href="https://map.kakao.com/link/map/${data[i].name},${data[i].lat},${data[i].lng}" target="_blank" title="새창열림">${data[i].name}</a>
									</td>
									<td>${data[i].addr || "데이터없음"}</td>
									<td>${data[i].created_at || "데이터없음"}</td>
									<td>${data[i].stock_at || "데이터없음"}</td>
									<td class="${data[i].remain_stat}">${getMaskStock(data[i].remain_stat)}</td>
								</tr>
							`;
							dataMarkUp += dataTemplete;
							loading.classList.remove('on');
							dataTable.innerHTML = dataMarkUp;
						};
					} else {
						dataTemplete = `
							<tr>
								<td colspan="5" style="margin:0; font-size:14px; font-weight:400; text-align:center !important;">검색결과가 존재하지 않습니다.</td>
							</tr>
						`;
						loading.classList.remove('on');
						dataTable.innerHTML = dataTemplete;
					};
					if (alertFlag) document.querySelector(".popup").classList.add('on');
				});
			getLocation();
		};

		(function init() {
			setTimeout(function() {
				location.reload();
			}, 1000 * count);
			setInterval(function() {
				count--;
				timer.innerText = count;
			}, 1000);
			
			let day = new Date().getDay(),
				currentSpot = localStorage.getItem(spot);
			
			input.value = currentSpot || "";
			today.innerText = setBuyYear(day) || "상관없이 모두";
			currentSpot = getData(currentSpot) || getLocation();
		})();
		
	</script>
</body>

</html>